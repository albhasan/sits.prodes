---
title: "Result record"
author: "Alber SÃ¡nchez"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>"
)

base_path <- "/home/alber/Documents/data/experiments/prodes_reproduction"

experiment_set <- list(few_cloud         = c("rep_prodes_40", "rep_prodes_41", "rep_prodes_42"), 
                       few_masked_clouds = c("rep_prodes_50", "rep_prodes_51", "rep_prodes_52"))

library(dplyr)
library(knitr)
library(xtable)
library(ggplot2)
library(sits.prodes)

accuracy_ls <- list()
accuracy_tb <- tibble::tibble()

warning("Run get_experiment_accuracy.R and devtools::build() to update the data in this package!")
stopifnot(file.exists(system.file("extdata/accuracy_ls.Rdata", package = "sits.prodes")))
load(system.file("extdata/accuracy_ls.Rdata", package = "sits.prodes"))
stopifnot(exists("accuracy_tb"))

if (length(accuracy_ls) > 0) {
accuracy_tb <- accuracy_ls %>% names() %>% 
    tibble::enframe(name = NULL) %>% 
    dplyr::rename("file_path" = "value")
}

if (nrow(accuracy_tb) > 0) {
    accuracy_tb <- accuracy_tb %>% 
        dplyr::mutate(acc_data = accuracy_ls,
                      experiment = stringr::str_extract(file_path, "rep_prodes_[0-9]+"), 
                      algorithm = purrr::map_chr(.$file_path, function(x){
                          unlist(stringr::str_split(stringr::str_extract(x, "results_[a-z]+"), '_'))[2]
                      }), 
                      smooth = stringr::str_extract(file_path, "smooth_[0-9]x[0-9]_n[0-9]{2}"), 
                      scene = stringr::str_extract(basename(file_path), "[0-9]{6}"),
                      pyear = purrr::map_chr(file_path, function(x){
                          as.integer(dplyr::last(unlist(stringr::str_extract_all(basename(x), "[0-9]{4}"))))
                      }),
                      overall = purrr::map_dbl(accuracy_ls, function(x){x$accuracy$overall}), 
                      overall2 = purrr::map_dbl(accuracy_ls, function(x){sits.prodes::asses_accuracy_simple(x$error_matrix)$overall}),
                      up_acc = purrr::map(accuracy_ls, function(x){
                           c(x$accuracy$user, x$accuracy$producer) %>%
                               tibble::enframe(name = NULL) %>%
                               dplyr::bind_cols(cname =  c(paste0("ua_", names(x$accuracy$user)), paste0("pa_", names(x$accuracy$producer))))  %>%
                               tidyr::spread("cname", "value") %>%
                               return()
                      }),
                      up_acc2 = purrr::map(accuracy_ls, function(x){
                          res <- sits.prodes::asses_accuracy_simple(x$error_matrix)
                          c(res$user, res$producer) %>%
                              tibble::enframe(name = NULL) %>%
                              dplyr::bind_cols(cname =  c(paste0("ua2_", names(res$user)), paste0("pa2_", names(res$producer)))) %>%
                              tidyr::spread("cname", "value") %>%
                              return()
                      })
        ) %>%
        dplyr::select(experiment, algorithm, scene, pyear, smooth, overall, overall2, up_acc, up_acc2, acc_data, file_path)
}

```




# Accuracy

It is a decomposition of the accuracy, originally proposed by Story and Congalton [@Story:1986].
* **Producers' accuracy** (omission error) is how well a specific area on the Earth is mapped. It 
is the probability that a reference sample is correctly classified. 
* **User's accuracy** (or reliability) is how well the map represents what is really on the ground.

![Exmple of user and producer accuracies](./img/user_producer_accuracy_example.png)

[TODO] Olafson extended this definition by pointig the need of normalizing the results using the area of on class


# Classification results

## Overall accuracy

* Random forest bahaves homogenously accros experiments, smooths, and scenes.
* Accuracy improvement due to smooth window size is marginal.
* Filling the clouds using with No Data decreses Deep Learning's accuracy.

```{r accuracy_overall, fig.width=7, fig.height=4, echo=FALSE}

if (nrow(accuracy_tb) > 0) {
    for (exp_set in seq_along(experiment_set)) {
        for (sm in unique(accuracy_tb$smooth)) {
            p <- accuracy_tb %>% 
                dplyr::filter(smooth == sm, 
                              experiment %in% experiment_set[[exp_set]]) %>%
                ggplot2::ggplot() + 
                #ggplot2::geom_line(aes(x = pyear, y = overall, group = experiment, color = experiment)) + 
                #ggplot2::geom_point(aes(x = pyear, y = overall, color = experiment)) + 
                ggplot2::geom_line(aes(x = pyear, y = overall2, group = experiment, color = experiment)) + 
                ggplot2::geom_point(aes(x = pyear, y = overall2, color = experiment)) + 
                ggplot2::facet_grid(scene ~ algorithm) +
                ggplot2::ggtitle(sprintf("Overall accuracy %s %s", names(experiment_set)[[exp_set]], sm)) + 
                ggplot2::coord_cartesian(ylim = c(0.5, 1))
            print(p)
        }
    }
}

```

## User-Producer accuracy


```{r accuracy_user_producer, fig.width=7, fig.height=4, echo=FALSE}

cnames <- colnames(accuracy_tb$up_acc[[1]])
#cnames <- colnames(accuracy_tb$up_acc2[[1]])
if (nrow(accuracy_tb) > 0) {
    for (exp_set in seq_along(experiment_set)) {
        for (sm in unique(accuracy_tb$smooth)) {
            for (al in unique(accuracy_tb$algorithm)) {
                p <- accuracy_tb %>% 
                    tidyr::unnest(up_acc) %>%
                    #tidyr::unnest(up_acc2) %>%
                    dplyr::select(-c(acc_data, file_path, overall, overall2)) %>%
                    tidyr::gather_(cnames, key = "up_accuracy", value = "up_value") %>%
                    dplyr::filter(smooth == sm, 
                                  algorithm == al,
                                  experiment %in% experiment_set[[exp_set]]) %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_line(aes(x = pyear, y = up_value, group = up_accuracy, color = up_accuracy)) + 
                    ggplot2::geom_point(aes(x = pyear, y = up_value, color = up_accuracy)) + 
                    ggplot2::facet_grid(experiment ~ scene) +
                    ggplot2::ggtitle(sprintf("Overall accuracy %s %s %s", names(experiment_set)[[exp_set]], al, sm)) 
                print(p)
            }
        }
    }
}


```



# TODO
* Vignette images too small
* Weird results for rep_prodes_5X. Check we're using the right samples
* Do the user-producer stat
* What is the difference between the overall accuracies of the caret package and sits.prodes?

# References
